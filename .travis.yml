sudo: required

services:
  - docker

branches:
  only:
    - develop
    - main

stages:
  - Test
  - name: Build
    if: branch = main
  - name: Migrate
    if: branch = main

jobs:
  include:
  - stage: Test
    name: "Running full test suit"
    before_install:
      - docker build -f docker/dockerfile -t russianbb/genesis-test .
    script:
    - docker run -e CI=true russianbb/genesis-test py.test -s ../../tests

  - stage: Build
    name: "Building and pushing docker images to be deployed"
    scripts:
      - echo "--> Starting Building Process"
      - docker --version  # document the version travis is using
      - pip install --user awscli # install aws cli w/o sudo
      - export PATH=$PATH:$HOME/.local/bin # put aws in the path
      - eval $(aws ecr get-login --no-include-email --region sa-east-1)
      - docker build -f docker/dockerfile -t $APP_NAME:$TRAVIS_BUILD_ID .
      - docker tag $APP_NAME:$TRAVIS_BUILD_ID $AWS_ECR_ACCOUNT.dkr.ecr.sa-east-1.amazonaws.com/$APP_NAME:$TRAVIS_BUILD_ID
      - docker push $AWS_ECR_ACCOUNT.dkr.ecr.sa-east-1.amazonaws.com/$APP_NAME:$TRAVIS_BUILD_ID

  - stage: Migrate
    name: "Running django migrations"
    scripts:
    - echo "Eventually runing the migrations"
